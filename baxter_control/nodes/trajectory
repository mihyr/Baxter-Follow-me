#!/usr/bin/env python
"""

**Info**: This *trajectory* node 

**Services**:



**Parameters**:

    
**Note**: -

"""
import rospy
import sys
import moveit_commander
from geometry_msgs.msg import Quaternion, Vector3, PoseStamped, Pose
from moveit_msgs.msg import MoveItErrorCodes
from baxter_control.srv import home, go2pose
import baxter_interface
from baxter_interface import Gripper
#Import params from waypoints.yaml

#freq = rospy.get_param("/Fr") #Define frequency rate
freq = 200





def main():
        
    #initialize moveit_commander
    joint_state_topic = ['joint_states:=/robot/joint_states']
    moveit_commander.roscpp_initialize(joint_state_topic)
    moveit_commander.roscpp_initialize(sys.argv)

    #initialize node
    rospy.init_node('trajectory')

    #instantiate a RobotCommander object
    robot = moveit_commander.RobotCommander()

    #instantiate a PlanningSceneInterface object
    scene = moveit_commander.PlanningSceneInterface()

    #logerr msg to check if node is running
    rospy.logerr("This is just a check for mover node, ignore me")

    #set group names 
    left_arm = "left_arm"
    left_hand = "left_hand"
    right_arm = "right_arm"
    right_hand = "right_hand"
    both_arms = "both_arms"

    #init MoveIt for groups
    left_arm_moveit = moveit_commander.MoveGroupCommander(left_arm)
    left_hand_moveit = moveit_commander.MoveGroupCommander(left_hand)
    right_arm_moveit = moveit_commander.MoveGroupCommander(right_arm)
    right_hand_moveit = moveit_commander.MoveGroupCommander(right_hand)
    both_arms_moveit = moveit_commander.MoveGroupCommander(both_arms)

    #define ros frequency
    hz = rospy.Rate(freq)

    #get current pose of robot
    left_current_pose = left_arm_moveit.get_current_pose(end_effector_link='left_gripper').pose
    right_current_pose = right_arm_moveit.get_current_pose(end_effector_link='right_gripper').pose
    print(left_current_pose)
    print(right_current_pose)

    # Planning to a Pose goal (relative)
    left_target_pose = left_current_pose
    left_target_pose.position.x = left_current_pose.position.x - 0.1 # 0.1m = 10 cm
    left_target_pose.position.z = left_current_pose.position.z - 0.1
    left_arm_moveit.set_pose_target(left_target_pose, end_effector_link='left_gripper')
    plan = left_arm_moveit.plan()
    left_arm_moveit.go()
    left_arm_moveit.stop()
    left_arm_moveit.clear_pose_targets()   

    '''
    
    '''
    #Define home_callback service
    def home_callback(msg):
        #reset both arms
        left_arm_moveit.set_named_target('left_neutral')
        right_arm_moveit.set_named_target('right_neutral')
        left_arm_moveit.go()
        right_arm_moveit.go()
        left_arm_moveit.stop()
        right_arm_moveit.stop()
        left_arm_moveit.clear_pose_targets()
        right_arm_moveit.clear_pose_targets()
        return {'response': "Home Position Set"}

    #Define go2pose_callback service
    def go2pose_callback(msg):
        #instantiate pose message
        pose_goal = Pose()
        #Get Position and quaternion orientation for arm from step service
        pose_goal.position = msg.goal_position
        pose_goal.orientation = msg.goal_orientation
        left_arm_moveit.set_pose_target(pose_goal, end_effector_link='left_gripper')

        #plan and execute
        (success_status, trajectory_message, planning_time, error) = left_arm_moveit.plan()
        left_arm_moveit.execute(trajectory_message, wait=True)
        left_arm_moveit.go()

        #stop and clear the target
        left_arm_moveit.stop()
        left_arm_moveit.clear_pose_targets()
        return {'response': "Home Position Set"}
     
    #init home, reset, step and follow services
    home_srv = rospy.Service("home", home, home_callback)
    go2pose_srv = rospy.Service("go2pose", go2pose, go2pose_callback)

    #iteration loop
    while not rospy.is_shutdown():

        #check
        #rospy.loginfo("check")
        
        #go to sleep!
        hz.sleep()

if __name__ == "__main__":
    try:
        main()
    except rospy.ROSInterruptException:
        pass 